<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Fiber 架构 | 此间少年</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/BlogSite/icon.jpeg">
    <meta name="description" content="我的个人博客">
    
    <link rel="preload" href="/BlogSite/assets/css/0.styles.a8333bdb.css" as="style"><link rel="preload" href="/BlogSite/assets/js/app.f80ff532.js" as="script"><link rel="preload" href="/BlogSite/assets/js/2.c40a7f93.js" as="script"><link rel="preload" href="/BlogSite/assets/js/7.5596e13c.js" as="script"><link rel="prefetch" href="/BlogSite/assets/js/10.c8755115.js"><link rel="prefetch" href="/BlogSite/assets/js/11.e9bc9278.js"><link rel="prefetch" href="/BlogSite/assets/js/12.702198d6.js"><link rel="prefetch" href="/BlogSite/assets/js/13.fee2c92b.js"><link rel="prefetch" href="/BlogSite/assets/js/14.1de4fe8a.js"><link rel="prefetch" href="/BlogSite/assets/js/15.7f0864b6.js"><link rel="prefetch" href="/BlogSite/assets/js/16.46b14f61.js"><link rel="prefetch" href="/BlogSite/assets/js/17.181e8fdc.js"><link rel="prefetch" href="/BlogSite/assets/js/18.2869f71d.js"><link rel="prefetch" href="/BlogSite/assets/js/19.40f949f2.js"><link rel="prefetch" href="/BlogSite/assets/js/20.edbdeccd.js"><link rel="prefetch" href="/BlogSite/assets/js/21.4237dc70.js"><link rel="prefetch" href="/BlogSite/assets/js/22.9164c593.js"><link rel="prefetch" href="/BlogSite/assets/js/23.1765a2b3.js"><link rel="prefetch" href="/BlogSite/assets/js/24.676031f3.js"><link rel="prefetch" href="/BlogSite/assets/js/25.ef9459bb.js"><link rel="prefetch" href="/BlogSite/assets/js/26.93fd537f.js"><link rel="prefetch" href="/BlogSite/assets/js/27.afefac8a.js"><link rel="prefetch" href="/BlogSite/assets/js/28.eff5e62b.js"><link rel="prefetch" href="/BlogSite/assets/js/29.c1b52190.js"><link rel="prefetch" href="/BlogSite/assets/js/3.8a9829f9.js"><link rel="prefetch" href="/BlogSite/assets/js/30.fd7c9e4f.js"><link rel="prefetch" href="/BlogSite/assets/js/31.cd7c2d4b.js"><link rel="prefetch" href="/BlogSite/assets/js/32.cccd3b30.js"><link rel="prefetch" href="/BlogSite/assets/js/33.4b16d62c.js"><link rel="prefetch" href="/BlogSite/assets/js/34.9e1aaadb.js"><link rel="prefetch" href="/BlogSite/assets/js/35.7a40efa8.js"><link rel="prefetch" href="/BlogSite/assets/js/36.ffa1aa10.js"><link rel="prefetch" href="/BlogSite/assets/js/37.862a37d3.js"><link rel="prefetch" href="/BlogSite/assets/js/38.ab2f96b1.js"><link rel="prefetch" href="/BlogSite/assets/js/39.775cfcd9.js"><link rel="prefetch" href="/BlogSite/assets/js/4.d5c4e325.js"><link rel="prefetch" href="/BlogSite/assets/js/40.a41b7367.js"><link rel="prefetch" href="/BlogSite/assets/js/41.31fe95c5.js"><link rel="prefetch" href="/BlogSite/assets/js/42.9e24ba32.js"><link rel="prefetch" href="/BlogSite/assets/js/43.4715374f.js"><link rel="prefetch" href="/BlogSite/assets/js/44.e1c9184d.js"><link rel="prefetch" href="/BlogSite/assets/js/45.456ef24f.js"><link rel="prefetch" href="/BlogSite/assets/js/46.42191eed.js"><link rel="prefetch" href="/BlogSite/assets/js/47.e7e43b6c.js"><link rel="prefetch" href="/BlogSite/assets/js/48.70268ffa.js"><link rel="prefetch" href="/BlogSite/assets/js/49.dee61fb0.js"><link rel="prefetch" href="/BlogSite/assets/js/5.ca4fb48c.js"><link rel="prefetch" href="/BlogSite/assets/js/50.b6fff098.js"><link rel="prefetch" href="/BlogSite/assets/js/51.76d7b2b4.js"><link rel="prefetch" href="/BlogSite/assets/js/52.d4b9bc59.js"><link rel="prefetch" href="/BlogSite/assets/js/53.67810278.js"><link rel="prefetch" href="/BlogSite/assets/js/54.2e423bcb.js"><link rel="prefetch" href="/BlogSite/assets/js/55.42fb0e1f.js"><link rel="prefetch" href="/BlogSite/assets/js/56.037545b8.js"><link rel="prefetch" href="/BlogSite/assets/js/57.a3a85cdc.js"><link rel="prefetch" href="/BlogSite/assets/js/58.6600c907.js"><link rel="prefetch" href="/BlogSite/assets/js/6.652dc7ac.js"><link rel="prefetch" href="/BlogSite/assets/js/8.fb830673.js"><link rel="prefetch" href="/BlogSite/assets/js/9.11b96c1d.js">
    <link rel="stylesheet" href="/BlogSite/assets/css/0.styles.a8333bdb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/BlogSite/" class="home-link router-link-active"><!----> <span class="site-name">此间少年</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端三剑客" class="dropdown-title"><span class="title">前端三剑客</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端三剑客" class="mobile-dropdown-title"><span class="title">前端三剑客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/BlogSite/html/" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/BlogSite/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/BlogSite/javascript/prototype/" class="nav-link">
  JavaScript
</a></li></ul></div></div><div class="nav-item"><a href="/BlogSite/http/" class="nav-link">
  HTTP
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端框架" class="dropdown-title"><span class="title">前端框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端框架" class="mobile-dropdown-title"><span class="title">前端框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/BlogSite/vue/" class="nav-link">
  vue2.0
</a></li><li class="dropdown-item"><!----> <a href="/BlogSite/vueNext/" class="nav-link">
  vue3.0
</a></li><li class="dropdown-item"><!----> <a href="/BlogSite/react/analysis/" class="nav-link router-link-active">
  React18
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="打包工具" class="dropdown-title"><span class="title">打包工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="打包工具" class="mobile-dropdown-title"><span class="title">打包工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/BlogSite/webpack/" class="nav-link">
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/BlogSite/rollup/" class="nav-link">
  rollup
</a></li><li class="dropdown-item"><!----> <a href="/BlogSite/vite/" class="nav-link">
  vite
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="面试分享" class="dropdown-title"><span class="title">面试分享</span> <span class="arrow down"></span></button> <button type="button" aria-label="面试分享" class="mobile-dropdown-title"><span class="title">面试分享</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/BlogSite/interviewQuestion/html/" class="nav-link">
  面试八股文
</a></li><li class="dropdown-item"><!----> <a href="/BlogSite/interviewCompany/company1/" class="nav-link">
  面试记录
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端三剑客" class="dropdown-title"><span class="title">前端三剑客</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端三剑客" class="mobile-dropdown-title"><span class="title">前端三剑客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/BlogSite/html/" class="nav-link">
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/BlogSite/css/" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/BlogSite/javascript/prototype/" class="nav-link">
  JavaScript
</a></li></ul></div></div><div class="nav-item"><a href="/BlogSite/http/" class="nav-link">
  HTTP
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端框架" class="dropdown-title"><span class="title">前端框架</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端框架" class="mobile-dropdown-title"><span class="title">前端框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/BlogSite/vue/" class="nav-link">
  vue2.0
</a></li><li class="dropdown-item"><!----> <a href="/BlogSite/vueNext/" class="nav-link">
  vue3.0
</a></li><li class="dropdown-item"><!----> <a href="/BlogSite/react/analysis/" class="nav-link router-link-active">
  React18
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="打包工具" class="dropdown-title"><span class="title">打包工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="打包工具" class="mobile-dropdown-title"><span class="title">打包工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/BlogSite/webpack/" class="nav-link">
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/BlogSite/rollup/" class="nav-link">
  rollup
</a></li><li class="dropdown-item"><!----> <a href="/BlogSite/vite/" class="nav-link">
  vite
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="面试分享" class="dropdown-title"><span class="title">面试分享</span> <span class="arrow down"></span></button> <button type="button" aria-label="面试分享" class="mobile-dropdown-title"><span class="title">面试分享</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/BlogSite/interviewQuestion/html/" class="nav-link">
  面试八股文
</a></li><li class="dropdown-item"><!----> <a href="/BlogSite/interviewCompany/company1/" class="nav-link">
  面试记录
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/BlogSite/react/analysis/" aria-current="page" class="sidebar-link">React 原理分析</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/BlogSite/react/mini-react/" class="sidebar-heading clickable"><span>React 源码实现</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="fiber-架构"><a href="#fiber-架构" class="header-anchor">#</a> Fiber 架构</h1> <h2 id="为什么需要-fiber"><a href="#为什么需要-fiber" class="header-anchor">#</a> 为什么需要 Fiber</h2> <p>我们知道，在浏览器中，页面是一帧一帧的绘制出来的，主流浏览器的刷新频率是 60次/秒，每个帧的预算时间是 16.66 毫秒 (1 秒/60)
。当每秒内绘制的帧数（FPS）超过60时，页面渲染是流畅的；而当FPS小于60时，会出现一定程度的卡顿现象。下面来看完整的一帧中，具体做了哪些事情：</p> <p><img src="/BlogSite/assets/img/lifeofframe.a6c9396c.jpeg" alt=""></p> <p>JavaScript 执行 Javascript 引擎和页面渲染引擎在同一个渲染线程,GUI 渲染和 Javascript 执行两者是互斥的，如果某个任务执行时间过长，浏览器会推迟渲染。例如在定时器阶段或Begin Frame阶段执行时间非常长，时间已经明显超过了16ms，那么就会阻塞页面的渲染，从而出现卡顿现象。</p> <p>在 React16 之前，react 的 dom-diff 是采用递归遍历 DOM 树，找出需要修改的节点，然后再进行更新。这种递归遍历一旦开始就不能中断，如果一个 DOM 节点的层次足够深，那么遍历节点所用的时间就会增加，如果遍历计算耗时 100ms，那么这 100ms浏览器是无法响应的，代码执行时间越长卡顿越明显。</p> <p>为了解决这个问题， React 在 16 版本之后引入了 Fiber 架构。将渲染/更新过程拆分为一个个小块的任务，通过合理的调度机制来调控时间，指定任务执行的时机，从而降低页面卡顿的概率，提升页面交互体验。通过 Fiber 架构，将原来的递归遍历的过程改为可中断和恢复。适时地让出CPU执行权，可以让浏览器及时地响应用户的交互。</p> <h2 id="什么是-fiber-架构"><a href="#什么是-fiber-架构" class="header-anchor">#</a> 什么是 Fiber 架构</h2> <p>Fiber 是一个一个执行单元，Fiber 也是一种数据结构。</p> <h3 id="一个执行单元"><a href="#一个执行单元" class="header-anchor">#</a> 一个执行单元</h3> <p>Fiber 是一个执行单元，每次执行完一个执行单元， React 就会检查现在还剩多少时间，如果没有时间就将控制权让出去。</p> <p><img src="/BlogSite/assets/img/fiberflow.194129b6.jpeg" alt=""></p> <h3 id="一种数据结构"><a href="#一种数据结构" class="header-anchor">#</a> 一种数据结构</h3> <p>React Fiber 是采用链表的数据结构实现的，React 将 虚拟DOM树 转换成 Fiber 树，每个虚拟DOM的节点都是一个FiberNode，每个 FiberNode 都有 child（指向自己的第一个子节点）、sibling（指向自己的下一个兄弟节点）、return（指向自己的父节点）。</p> <p><img src="/BlogSite/assets/img/fibertree.1b4d122c.jpg" alt=""></p> <h2 id="fiber-执行原理"><a href="#fiber-执行原理" class="header-anchor">#</a> Fiber 执行原理</h2> <p>从根节点开始渲染和调度的过程可以分为两个阶段：render 阶段、commit 阶段。</p> <ul><li>render 阶段：这个阶段是可中断的，会找出所有节点的变更。</li> <li>commit 阶段：这个阶段是不可中断的，会执行所有的变更。</li></ul> <h3 id="render-阶段"><a href="#render-阶段" class="header-anchor">#</a> render 阶段</h3> <p>此阶段会找出所有节点的变更，如节点新增、删除、属性变更等，此阶段会构建一棵 Fiber tree，以虚拟 dom 节点为维度对任务进行拆分，即一个虚拟 dom 节点对应一个任务，从中可以知道哪些节点更新、哪些节点增加、哪些节点删除了。</p> <h4 id="遍历-流程"><a href="#遍历-流程" class="header-anchor">#</a> 遍历 流程</h4> <p>React Fiber首先是将虚拟DOM树转化为 Fiber tree，因此每个节点都有 child、sibling、return 属性，遍历 Fiber tree 标记节点的操作类型：</p> <p><img src="/BlogSite/assets/img/fibertree2.ad666a35.jpg" alt=""></p> <p>相关文章：</p> <p><a href="https://juejin.cn/post/6943896410987659277#heading-15" target="_blank" rel="noopener noreferrer">淘系前端团队: 走进React Fiber的世界<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/BlogSite/assets/js/app.f80ff532.js" defer></script><script src="/BlogSite/assets/js/2.c40a7f93.js" defer></script><script src="/BlogSite/assets/js/7.5596e13c.js" defer></script>
  </body>
</html>
